name: PR commented

on:
  issue_comment:
    types: [created]

jobs:
  my_test_on_comment:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.pull_request }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}
      PR_NUMBER: ${{ github.event.issue.number }}
      USER_NAME: ${{ github.event.comment.user.login }}
      STATUS_CHECK_STATE: success
      STATUS_CHECK_CONTEXT: e2e_check
      STATUS_CHECK_DESCRIPTION: End to end testing

    steps:
      - run: echo "${{ toJSON(github.event) }}"
      - run: echo "${{ toJSON(github.token) }}"
      - run: echo "$GH_TOKEN"

      - name: Parse comment
        id: parseComment
        env:
          COMMENT_TEXT: ${{ github.event.comment.body }}
        run: |
          IFS=" "
          read -ra COMMENT_ARRAY <<< "$COMMENT_TEXT"

          COMMAND=${COMMENT_ARRAY[0]} 
          PARAMETER=${COMMENT_ARRAY[1]}

          if [[ $COMMAND == "/e2e" && $PARAMETER != "" ]]
          then
            if [[ $PARAMETER == "skip" ]]
            then
              echo "ACTION=SKIP_TEST" >> $GITHUB_OUTPUT
            else
              echo "ACTION=RUN_TEST" >> $GITHUB_OUTPUT
              echo "ENVIRONMENT=${PARAMETER}" >> $GITHUB_OUTPUT
            fi
          else
            echo "ACTION=NOTHING" >> $GITHUB_OUTPUT
          fi

      - name: Checkout tests
        if: steps.parseComment.outputs.ACTION == 'RUN_TEST'
        uses: actions/checkout@v4
        with: 
          repository: gabrielwillemann/cypress-e2e-testing
          ref: DXP-740-integration-with-pipeline
          # repository: viafoura/cypress-e2e-testing

          # https://stackoverflow.com/questions/71068476/accessing-another-repository-with-github-cli-in-github-actions
          # TO-DO: Ask for SRE to generate a token in production
          token: ${{ secrets.MY_PTA }}

      - name: Copy Environment Variables
        if: steps.parseComment.outputs.ACTION == 'RUN_TEST'
        env:
          ENVIRONMENT: ${{ steps.parseComment.outputs.ENVIRONMENT }}
        run: cp cypress/environment-variables/$ENVIRONMENT.json cypress.env.json

      - name: Install Test Dependencies
        if: steps.parseComment.outputs.ACTION == 'RUN_TEST'
        run: npm ci

      - name: Execute test
        if: steps.parseComment.outputs.ACTION == 'RUN_TEST'
        run: npm run cypress:run:ci

      - name: Comment with results
        if: steps.parseComment.outputs.ACTION == 'RUN_TEST'
        env:
          ENVIRONMENT: ${{ steps.parseComment.outputs.ENVIRONMENT }}
        run: |
          gh pr comment $PR_NUMBER --body "Tests ran by @$USER_NAME in $ENVIRONMENT"

      - name: Comment tests skkiped
        if: steps.parseComment.outputs.ACTION == 'SKIP_TEST'
        run: |
          gh pr comment $PR_NUMBER --body "Tests skipped by @$USER_NAME"

      - name: Get SHA of PR
        if: steps.parseComment.outputs.ACTION != 'NOTHING'
        id: getSHA
        run: |
          PR_JSON=$(gh api /repos/$GH_REPO/pulls/$PR_NUMBER)
          SHA=$(echo $PR_JSON | jq -r .head.sha)
          echo "SHA=$SHA" >> $GITHUB_OUTPUT

      - name: Mark PR as checked
        if: steps.parseComment.outputs.ACTION != 'NOTHING'
        env:
          SHA: ${{ steps.getSHA.outputs.SHA  }}
        run: |
          gh api \
            --method POST /repos/$GH_REPO/statuses/$SHA \
            -f state="$STATUS_CHECK_STATE" \
            -f context="$STATUS_CHECK_CONTEXT" \
            -f description="$STATUS_CHECK_DESCRIPTION"
