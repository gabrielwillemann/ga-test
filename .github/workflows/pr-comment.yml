name: PR commented

on:
  issue_comment:
    types: [created]

jobs:
  my_test_on_comment:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.pull_request }}
    steps:
      - run: echo "${{ toJSON(github.event.comment) }}"
      - name: Parse comment
        id: parseComment
        env:
          COMMENT_TEXT: ${{ github.event.comment.body }}
        run: |
          IFS=" "
          read -ra COMMENT_ARRAY <<< "$COMMENT_TEXT"

          COMMAND=${COMMENT_ARRAY[0]} 
          PARAMETER=${COMMENT_ARRAY[1]}

          if [[ $COMMAND == "/e2e" && $PARAMETER != "" ]]
          then
            if [[ $PARAMETER == "skip" ]]
            then
              echo "ACTION=SKIP_TEST" >> $GITHUB_OUTPUT
            else
              echo "ACTION=RUN_TEST" >> $GITHUB_OUTPUT
              echo "ENVIRONMENT=${PARAMETER}" >> $GITHUB_OUTPUT
            fi
          else
            echo "ACTION=NOTHING" >> $GITHUB_OUTPUT
          fi
      - name: Execute test
        if: steps.parseComment.outputs.ACTION == 'RUN_TEST'
        env:
          ENVIRONMENT: ${{ steps.parseComment.outputs.ENVIRONMENT }}
        run: echo "Run tests in ${ENVIRONMENT}"
      - name: Comment with results
        if: steps.parseComment.outputs.ACTION == 'RUN_TEST'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.issue.number }}
          USER_NAME: ${{ github.event.comment.user.login }}
          ENVIRONMENT: ${{ steps.parseComment.outputs.ENVIRONMENT }}
        run: |
          gh pr comment $PR_NUMBER --body "Tests ran by @$USER_NAME in $ENVIRONMENT"
      - name: Comment tests skkiped
        if: steps.parseComment.outputs.ACTION == 'SKIP_TEST'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.issue.number }}
          USER_NAME: ${{ github.event.comment.user.login }}
        run: |
          gh pr comment $PR_NUMBER --body "Tests skipped by @$USER_NAME"

